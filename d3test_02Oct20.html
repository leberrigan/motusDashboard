 <!DOCTYPE HTML>

<meta charset="utf-8">

  <meta name=”viewport” content=”width=device-width, initial-scale=1.0">

<html>
<head>

<title>Motus D3 Test</title>

  <style>
    rect.bar-rect { stroke:#000; }
    rect.bar-rect:hover { 
      fill-opacity:0.75;
      transition: all .2s;
	  cursor:pointer;
    }
  </style>
  
  <script src="https://d3js.org/d3.v6.js"></script>
  
  <script type='text/javascript'>
  
		  
		// Keep a global object of all charts
		var allCharts = {};

		// Project selection dropdown
		var proj_s;

		// Default project
		var selectedProj = 2;


		function initiateChart(chartID, opts) {
		
			opts.xAxisLabels = opts.xAxisLabels === undefined ? function(d){return d;} : opts.xAxisLabels;
			opts.yAxisLabels = opts.yAxisLabels === undefined ? function(d){return d;} : opts.yAxisLabels;
			opts.w = opts.w === undefined ? 1000 : opts.w;
			opts.h = opts.h === undefined ? 600 : opts.h;
			opts.m = opts.m === undefined ?  [20, 20, 100, 100] : opts.m;

			var c = {
				source: opts.dataSource,
				xvar: opts.xvar,
				xwidth: opts.xwidth,
				yvar: opts.yvar,
				width: opts.w, 
				height: opts.h, 
				margin:{
					top: opts.m[0], 
					right: opts.m[1], 
					bottom: opts.m[2],
					left: opts.m[3]
				},
				xAxisLabels: opts.xAxisLabels,
				yAxisLabels: opts.yAxisLabels,
				chartType: opts.chartType,
				graphWidth:  opts.w - opts.m[3] - opts.m[1],
				graphHeight: opts.h - opts.m[0] - opts.m[2]
			}
			
			c.svg = d3.select(chartID)
			  .append('svg')
			  .attr('width', c.width)
			  .attr('height', c.height);
			
			c.graph = c.svg.append('g')
			  .attr('width', c.graphWidth)
			  .attr('height', c.graphHeight)
			  .attr('transform', `translate(${c.margin.left}, ${c.margin.top})`);
			 
			c.tooltip = c.svg.append('div')
				.style('position','absolute')
				.style('visibility','hidden');
			 
			c.gXAxis = c.graph.append('g')
				.attr('transform', `translate(0, ${c.graphHeight})`);
				
			c.gYAxis = c.graph.append('g');
			
			
			allCharts[chartID] = c;
		}
		
		function dataSummary(d, keyname, valname) {
			var data = [];
			for (i in d) {
				data[i] = {};
				data[i][keyname] = d[i][0];
				data[i][valname] = d[i][1];
			}
			return data;
		}

		function loadChart(chartID) {

			d3.json('data/proj' + selectedProj + '-' + allCharts[chartID].source + '.txt').then(function(json_file, chart = chartID) {
			
				var data = json_file["data"];
				
				var yvals, y, x, rects;
				
				if (allCharts[chartID].chartType === "count") {
					
					data = dataSummary(	
														d3.rollups(data, 
																		v => v.length, 
																		d => allCharts[chartID].xvar(d)
																		), 
														keyname = allCharts[chartID].xvar(), 
														valname = "count"
													);
				} 
				
				
				if (allCharts[chartID].chartType === "count" || allCharts[chartID].chartType === "bar") {
				
				
					
					var colourScale = d3.scaleOrdinal()
											.domain(data.map(item => allCharts[chartID].yvar(item)))
											.range(d3.schemeCategory10);
											
					y = d3.scaleLinear()
						.domain([0, d3.max(data, d => allCharts[chartID].yvar(d))])
						.range([allCharts[chart].graphHeight, 0]); 

					x = d3.scaleBand()
						.domain(data.map(item => allCharts[chartID].xvar(item)))
						.range([0, allCharts[chart].graphWidth])
						.paddingInner(0.2)
						.paddingOuter(0.2);
					rects = allCharts[chart].graph.selectAll('rect').data(data);  
					
					rects.attr('width', x.bandwidth)
						.attr('class', 'bar-rect')
						.attr('height', d => allCharts[chart].graphHeight - y(allCharts[chartID].yvar(d)))
						.attr('x', d => x(allCharts[chartID].xvar(d)))
						.attr('y', d => y(allCharts[chartID].yvar(d)));  
						
					rects.enter()
						.append('rect')
						.attr('class', 'bar-rect')
						.attr('width', x.bandwidth)
						.attr('height', d => allCharts[chart].graphHeight - y(allCharts[chartID].yvar(d)))
						.attr('x', d => x(allCharts[chartID].xvar(d)))
						.attr('y', d => y(allCharts[chartID].yvar(d)))
						.style('fill', function(d, i) {return colourScale(i);});
					
					rects.exit().remove();
					
					
					const xAxis = d3.axisBottom(x)
						.tickFormat(allCharts[chartID].xAxisLabels);  ;
					const yAxis = d3.axisLeft(y)
						.tickFormat(allCharts[chartID].yAxisLabels);  
						
					allCharts[chart].gXAxis.call(xAxis);
						
					allCharts[chart].gYAxis.call(yAxis);  
					
					allCharts[chart].gXAxis.selectAll('text')
						.style('font-size', 14)
						.style("text-anchor", "end")
						.attr("dx", "-.8em")
						.attr("transform", "rotate(-65)");
					 
					allCharts[chart].gYAxis.selectAll('text')
						.style('font-size', 14);
				} else if (allCharts[chartID].chartType === "deployment-timeline") {
					console.log(data)
				// x-axis is linear because it is a date object
					x = d3.scaleLinear()
						.domain([
										d3.min(data, d => allCharts[chartID].xvar(d)), 
										d3.max(data, d => allCharts[chartID].xvar(d) + allCharts[chartID].xwidth(d))
									])
						.range([0, allCharts[chart].graphWidth]); 
						
				// y-axis is ordinal because it is deploy IDs
					y = d3.scaleBand()
						.domain(data.map(item => allCharts[chartID].yvar(item)))
						.range([0, allCharts[chart].graphHeight])
						.paddingInner(0.2)
						.paddingOuter(0.2);
						
					
					var colourScale = d3.scaleOrdinal()
											.domain(data.map(item => allCharts[chartID].yvar(item)))
											.range(d3.schemeCategory10);
											
					rects = allCharts[chart].graph.selectAll('rect').data(data);  
					
					rects.attr('height', y.bandwidth)
						.attr('class', 'bar-rect')
						.attr('width', d => x(allCharts[chartID].xwidth(d)))
						.attr('x', d => x(allCharts[chartID].xvar(d)))
						.attr('y', d => y(allCharts[chartID].yvar(d)));  
						
					rects.enter()
						.append('rect')
						.attr('class', 'bar-rect')
						.attr('height', y.bandwidth)
						.attr('width', d => x(allCharts[chartID].xwidth(d) + allCharts[chartID].xvar(d)) - x(allCharts[chartID].xvar(d)))
						.attr('x', d => x(allCharts[chartID].xvar(d)))
						.attr('y', d => y(allCharts[chartID].yvar(d)))
						.style('fill', function(d, i) {return colourScale(i);});
						
						
					rects.exit().remove();
					
					const asDate = function(d) {
						return new Date(d);
					}
					
					
					const xAxis = d3.axisBottom(x)
//						.tickFormat(d => `${d}` + allCharts[chartID].xAxisLabels);  
						.tickFormat(d => asDate(d)).tickFormat(d3.timeFormat("%b-%Y"));
					const yAxis = d3.axisLeft(y)
						.tickFormat(allCharts[chartID].yAxisLabels);  
						
					allCharts[chart].gXAxis.call(xAxis);
						
					allCharts[chart].gYAxis.call(yAxis);  
					
					allCharts[chart].gYAxis.selectAll('text')
						.style('font-size', 14)
						.style("text-anchor", "end")
						.attr("dx", "-.8em");
					 
					allCharts[chart].gXAxis.selectAll('text')
						.style('font-size', 14);
					
				}

			});

		}


		function updateCharts() {
			selectedProj = proj_s.options[proj_s.selectedIndex].id.replace("proj", "");
			for (chart in allCharts) {
				loadChart(chart)
			}
		}
		
		// Load projects into dropdown
		d3.json('data/projs.txt').then(json_file => {
		
			proj_s = document.getElementById("allProjs");
			
			var data = json_file['data'];
			
			d3.select("#allProjs")
				.on("change", updateCharts)
				.selectAll('option')
				.data(data)
				.enter()
				.append("option")
				.attr("id", function(d){return "proj"+d.projectID;})
				.text(function(d){return d.projectName;})
				.property("selected", function(d){ return d.projectID == 9; });
		
			updateCharts();

		});
		d3.html("https://motus.org/data/receiverDeploymentDetections?n=1000&q=&f=1&o=0a1a2a3a4a5a&id=2952", function(d){
				
			console.log(d);
		//	var nRecvs = d.selectAll(".motus-table tr").length;
		//	console.log(nRecvs);
		});
		
		
		
  </script>
  
</head>

<body>

<select id='allProjs'>

</select>


  <div id="chart4"></div>
  
  <div id="chart1"></div>
  <div id="chart2"></div>
  <div id="chart3"></div>
  
<script type='text/javascript'>

const calculate_timeActive = function(d){
	return ((isNaN(+d.tsEnd) ? +(Date.now()) : +d.tsEnd * 1000) - (+d.tsStart * 1000));
}

const calculate_tsEnd = function(d){
	return d===undefined ? 
											"tsEnd"
											: 
											isNaN(+d["tsEnd"]) ?	
																			Date.now()
																			: 
																			+d["tsEnd"] * 1000;
}

var chart1_opts = {
	dataSource: "recv-deps",
	xvar: function(d){return d===undefined?"siteName":d["siteName"];},
	yvar: function(d){return d===undefined?"count":d["count"];},
	chartType: 'count',
	w: 500,
	h: 300
}
var chart2_opts = {
	dataSource: "tag-deps",
	xvar: function(d){return d===undefined?"motusEnglishName":d["motusEnglishName"];},
	yvar: function(d){return d===undefined?"count":d["count"];},
	chartType: 'count',
	w: 500,
	h: 300
}
var chart3_opts = {
	dataSource: "recv-deps",
	//xvar: function(d){return d===undefined?"recvDeployID":d["recvDeployID"];},
	xvar: function(d){return d===undefined?"recvDeployID":d["recvDeployID"];},
	yvar: calculate_timeActive,
	chartType: 'bar',
	yAxisLabels: function(d){return Math.round(d / ( 1000 * 3600 * 24 ) ) + ' days';}
}

var chart4_opts = {
	dataSource: "recv-deps",
	//xvar: calculate_tsEnd,
	xwidth: calculate_timeActive,
	xvar: function(d){return d===undefined?"tsStart":d["tsStart"]*1000;},
//	yvar: function(d){return d===undefined?"receiverID":d["receiverID"];},
	yvar: function(d){return d===undefined?"siteName":d["siteName"];},
	chartType: 'deployment-timeline'
}

initiateChart("#chart1", chart1_opts);
initiateChart("#chart2", chart2_opts);
initiateChart("#chart3", chart3_opts);
initiateChart("#chart4", chart4_opts);


</script>




</body>

</html>
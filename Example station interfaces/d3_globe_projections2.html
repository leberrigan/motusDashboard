
<!DOCTYPE html>
<meta charset="utf-8">

<style>


.explore-choropleth-stroke {
  fill: none;
  stroke: #000;
  stroke-width: 1px;
}
.explore-choropleth-graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
}
.explore-choropleth-fill {
  fill: none;
}
.explore-choropleth-land {
  fill: #222;
}
/*.land:hover {
  fill: #F22;
}*/
.explore-choropleth-sphere {
	fill: #AAF;
}
.explore-choropleth-boundary {
  fill: #FFF;
  stroke: #fff;
  stroke-width: .5px;
}
.explore-choropleth-track {
	stroke-width: 0.5px;
	opacity: 0.5;
	cursor: pointer;
}
</style>

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<!-- Create an element where the map will take place -->
<svg id="explore_mapStations_regions" class="explore_map explore_type_stations mapStations_type_regions" width="1200" height="400"></svg>

<label for='explore-choropleth-naturalEarth'>Natural Earth</label><input type='radio' name='explore-choropleth-mapType' id='explore-choropleth-naturalEarth' checked='checked' />
<label for='explore-choropleth-orthographic'>Orthographic</label><input type='radio' name='explore-choropleth-mapType' id='explore-choropleth-orthographic' />
<input type='button' value='Reset' id='explore-choropleth-resetMap' />
<script>

// 
// D3 Globe projections: https://github.com/d3/d3-geo
//		Orthographic: 
// 
// Tween between projections: https://bl.ocks.org/git-ashish/35d6480d477d22a21961e641955ba03c
//
// Transition between any two projections: https://bl.ocks.org/alexmacy/082cb12c8f4d5c0d5c4445c16a3db383
//
// Great circle paths: https://www.d3-graph-gallery.com/graph/connectionmap_csv.html
//
// Flight path edge bundling: https://bl.ocks.org/sjengle/2e58e83685f6d854aa40c7bc546aeb24
//
// Voronoi Arc Map: https://bl.ocks.org/mbostock/7608400
//
// Zoomable choropleth: https://observablehq.com/@bjnsn/zoomable-choropleth

// The svg

var svg = {
	el: d3.select("svg"),
	t: d3.timer(function() {}),
	width: 1200,
	height: 400,
	timer: d3.timer(function() {}),
	resetTimer: d3.timer(function() {}),
	selectedProjection: 0,
	posX: 0,
	posY: 0,
	tweenProjections: function(projectionID) {
		svg.selectedProjection = projectionID == "orthographic" ? 1 : 0;
		svg.centerX = svg.selectedProjection === 0 ? 0 : 36;
		svg.centerY = svg.selectedProjection === 0 ? 0 : -15;
		svg.proj_pos = svg.selectedProjection;
		svg.projectionMorph();
		svg.t.restart(function(elapsed) {
			svg.proj_pos = (elapsed/500)
			svg.proj_pos = svg.proj_pos > 1 ? 1 : svg.proj_pos
			svg.proj_pos = svg.selectedProjection == 0 ? 1 - svg.proj_pos : svg.proj_pos;
			svg.projectionMorph();
			if (elapsed > 500) svg.t.stop();
		}, 0)
	},	// Map and projection
	projection: d3.geoOrthographic().scale(100).clipAngle(90),
	path: d3.geoPath(),// A path generator 
	proj_pos: 0,
	grid: {},
	centerX: 36,
	centerY: -15,
	zoom: {},
	zoomLevel: 1,
	colorScale: {},
	resetCenter: function() {
		svg.el.transition().duration(750).call(svg.zoom.transform, d3.zoomIdentity);
		svg.resetTimer.restart(function(elapsed) {
			//elapsed = Math.max(0, (1000 - elapsed));
			svg.posX = ((Math.min(1000, elapsed) / 1000) * svg.centerX) + (svg.posX * (Math.max(0, (1000 - elapsed)) / 1000));
			svg.posY = ((Math.min(1000, elapsed) / 1000) * svg.centerY) + (svg.posY * (Math.max(0, (1000 - elapsed)) / 1000));
			//posY = () posY * (Math.max(0, (1000 - elapsed)) / 1000);
			svg.projectionMorph();
			if (svg.posX == svg.centerX && svg.posY == svg.centerY) svg.resetTimer.stop();
		});
	},
	ready: function(error, dataGeo, data) {
		
		svg.colorScale = d3.scaleOrdinal(d3.schemePaired);
				  
		var defs = svg.el.append("defs")

		defs.append("path")
			.datum({type: "Sphere"})
			.attr("id", "sphere")
			
		svg.el.append("use")
			.attr("class", "explore-choropleth-stroke")
			.attr("xlink:href", "#sphere");

		svg.el.append("use")
			.attr("class", "explore-choropleth-fill")
			.attr("xlink:href", "#sphere");

		svg.proj_pos = d3.select('input[name=explore-choropleth-mapType]:checked').attr('id') == 'orthographic' ? 1 : 0;
		
		// Reformat the list of link. Note that columns in csv file are called long1, long2, lat1, lat2
		var link = [];
		
		data.forEach(function(row){
			source = [+row.lon1, +row.lat1]
			target = [+row.lon2, +row.lat2]
			topush = {type: "LineString", coordinates: [source, target], id: row.tagDeployID}
			link.push(topush)
		});
		
		// Draw the map
		const land = svg.el.append("g");
		
		land.selectAll("path")
			.data(dataGeo.features)
			.enter().append("path")
				.attr("class", "explore-choropleth-land")
				.attr("d", d3.geoPath()
					.projection(svg.projection)
				)
				.style("stroke", "#FFF")
				.style("stroke-width", 0);
			
		// Add the path
		const tracks = svg.el.selectAll("myPath");
		
		tracks.data(link)
			.enter()
			.append("path")
			.attr("class", "explore-choropleth-track")
			.attr("d", (d) => svg.path(d))
			.attr('class', (d) => "track track" + d.id)
			.style("fill", "none")
			.style('stroke', (d) => svg.colorScale(d.id))
			.on('mouseover', function(d){
				d3.selectAll(".explore-choropleth-track" + d.id).style('opacity', '1');
				d3.selectAll(".explore-choropleth-track:not(.explore-choropleth-track" + d.id + ")").style('opacity', '0.1');
			})
			.on('mouseout', function(d){d3.selectAll(".explore-choropleth-track").style('opacity', '0.5');});
			
		svg.zoom = d3.zoom()
			.scaleExtent([1, 10])
			.translateExtent([[0, 0], [900, 600]])
			.extent([[0, 0], [900, 600]])
			.on("zoom", function() {
				svg.el.selectAll('path')
					.attr("transform", d3.event.transform);
			})
			.on('end', function() {
				svg.zoomLevel = d3.event.transform.k;
			});
		
		svg.el.call(svg.zoom);
		
		svg.projectionMorph();
		svg.resetCenter();

	},
	dragged: function() {
		svg.posX = ( svg.posX + d3.event.dx / (4 * svg.zoomLevel) ) % 360;
		svg.posY = ( svg.posY - d3.event.dy / (4 * svg.zoomLevel) ) % 360;
		svg.projectionMorph();
	},
	projectionMorph: function() {
		var t = svg.proj_pos;
		var projections = [d3.geoNaturalEarth(), d3.geoOrthographic()];
		
		  
		svg.centerX = svg.selectedProjection == 0 ? 0 : 36;
		svg.centerY = svg.selectedProjection == 0 ? 0 : -15;
	  
		svg.el.selectAll("path")
		  .attr("d", getProjection)
		  
		function getProjection(d) {
			var projection = d3.geoProjection(project)
				.rotate([svg.posX, svg.posY])
			   // .rotate([posX + 36, posY - 15])
				.fitExtent([[10, 10], [svg.width - 10, svg.height - 10]], {
				  type: "Sphere"
				});

			var path = d3.geoPath(projection);

			var clip = projection.clipAngle;

			clip( t == 0 ? null : (180 - (t * 90)) )

			function project(λ, φ) {
			  λ *= 180 / Math.PI, 
			  φ *= 180 / Math.PI;

			  var p0 = projections[0]([λ, φ]), 
				  p1 = projections[1]([λ, φ]);

			  return [
				(1 - t) * p0[0] + t * p1[0], 
				(1 - t) * -p0[1] + t * -p1[1]
				];
			}
			projection.alpha = function(_) {
				if (!arguments.length) return α;
				α = +_;
				var ca = a.center(), cb = b.center(),
				ta = a.translate(), tb = b.translate();
				center([(1 - α) * ca[0] + α * cb[0], (1 - α) * ca[1] + α * cb[1]]);
				translate([(1 - α) * ta[0] + α * tb[0], (1 - α) * ta[1] + α * tb[1]]);
				if (ortho === true) {clip(180 - α * 90);}
				return projection;
			};

			return path(d)
		}

	}
};

svg.path = svg.path.projection(svg.projection);

svg.grid = svg.el.append("path");

svg.el
	.call(d3.drag().on("drag", svg.dragged))
	.attr("width", svg.width)
	.attr("height", svg.height);

d3.selectAll('input[name=explore-choropleth-mapType]')
	.on('change', function(){svg.tweenProjections(this.id.replace('explore-choropleth-',''));});

svg.grid.datum(d3.geoGraticule().step([10, 10]))
	.attr("class", "explore-choropleth-graticule")
	.attr("d", svg.path)
	.style("stroke", "#CCC");
		
// Load world shape AND list of connection
d3.queue()
 // .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")  // World shape
  .defer(d3.json, "https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_countries.geojson")  // World shape
//  .defer(d3.csv, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_connectionmap.csv") // Position of circles
  .defer(d3.csv, "./data/siteTrans1.csv") // Position of circles
  .await(svg.ready);
  
d3.select('#resetMap').on('click', svg.resetCenter);

</script>
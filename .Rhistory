allTracks.df <- allTracks.df.raw %>%
rename(deployID = tagDeployId, lat = latitude, lon = longitude) %>%
left_join(recvDeps, by = c('lat','lon')) %>%
left_join(stations.by.recv, by = c("recvDeployID")) %>%
group_by(deployID) %>%
arrange(end_s) %>%
mutate(lat1 = lag(lat),
lon1 = lag(lon),
lat2 = lat,
lon2 = lon,
recv1 = lag(stationID),
recv2 = stationID,
recvProj1 = lag(projID),
recvProj2 = projID,
ts1 = lag(end_s),
ts2 = begin_s,
route = ifelse(recv1 < recv2, paste(recv1, recv2, sep = '.'), paste(recv2, recv1, sep = '.')),
dir = ifelse(recv1 < recv2, 1, -1)
#   route = ifelse(lat1 < lat2, paste(lat1, lon1, lat2, lon2, sep = ','),  paste(lat2, lon2, lat1, lon1, sep = ','))
#         route = as.integer(as.factor(route))
) %>%
dplyr::select(-projID) %>%
filter(!is.na(route),
recv1!=recv2) %>%
left_join(dplyr::select(tagDeps, deployID, projID, species = speciesID, freq), by = 'deployID') %>%
filter(!is.na(projID) & !is.na(species)) %>%
left_join(antDeps2.df, by = 'recvDeployID') %>%
mutate(freq = as.character(ifelse(is.na(freq.x), freq.y, freq.x))) %>%
group_by(route) %>%
summarise(animal = paste((deployID), collapse=','),
species = paste((species), collapse=','),
type = "LineString",
frequency = paste(freq, collapse=','),#Mode(freq, na.rm = T),
project = paste(projID, collapse=','),
recv1 = recv1[1],
recv2 = recv2[1],
lon1 = lon1[1],
lat1 = lat1[1],
lon2 = lon2[1],
lat2 = lat2[1],
recvProjs = paste(c(recvProj1[1], recvProj2[1]), collapse=','),
tsStart = paste(ts1, collapse=','),
tsEnd = paste(ts2, collapse=','),
dtStart = paste(as.Date(as.POSIXct(ts1, origin = '1970-01-01')), collapse=','),
#      dtStart = (as.Date(as.POSIXct(min(ts1, na.rm = T), origin = '1970-01-01'))),
#      dtEnd = (as.Date(as.POSIXct(max(ts2, na.rm = T), origin = '1970-01-01'))))
dtEnd = paste(as.Date(as.POSIXct(ts2, origin = '1970-01-01')), collapse=','),
dist = distHaversine(c(lon1, lat1), c(lon2, lat2)),
dir = paste(dir, collapse=','))
View(allTracks.df)
allTracks.df %>%  write.csv(paste0(dashboard.dir,'siteTrans_real2.csv'), row.names = F)
allTracks.df %>% select(recv1, recv2)
allTracks.df %>% select(recv1, recv2) %>% unlist
allTracks.df %>% select(recv1, recv2) %>% unlist %>% unique
testUnique1 <- allTracks.df %>% select(recv1, recv2) %>% unlist %>% unique
stations.df
stations.df$id
testUnique1 %in% stations.df$id
which(!testUnique1 %in% stations.df$id)
which(testUnique1 %in% stations.df$id)
which(testUnique1 %in% stations.df$id) %>% length
which((allTracks.df %>% select(recv1, recv2) %>% unlist %>% unique) %in% stations.df$id) %>% length
which(!(allTracks.df %>% select(recv1, recv2) %>% unlist %>% unique) %in% stations.df$id) %>% length
View(stations.df)
stations.df %>% write.csv(paste0(dashboard.dir, 'stations.csv'), row.names = F)
stations.df %>% write.csv(paste0(dashboard.dir, 'stations.csv'), row.names = F)
recvDeps.df %>%
ungroup() %>%
mutate(dtStart = as.Date(dtStart),
dtEnd = ifelse(is.na(dtEnd), Sys.Date(), as.Date(dtEnd))) %>%
View
recvDeps.df %>%
ungroup() %>%
mutate(dtStart = as.Date(dtStart),
dtEnd = if_else(is.na(dtEnd), Sys.Date(), as.Date(dtEnd))) %>%
View
stations.df <- recvDeps.df %>%
ungroup() %>%
mutate(dtStart = as.Date(dtStart),
dtEnd = if_else(is.na(dtEnd), Sys.Date(), as.Date(dtEnd))) %>%
filter(nchar(name) > 0 & !is.na(dtStart)) %>%
group_by(name) %>%
summarise(nDeps = length(unique(id)),
stationDeps = paste0(id, collapse = ';'),
id = id[1],
name = name[1],
lat = median(lat[1], na.rm = T),
lon = median(lon[1], na.rm = T),
frequency = paste0(unique(frequency), collapse = ';'),
projID = paste0(unique(projID), collapse = ';'),
dtStart = as.character(min(dtStart, na.rm = T)),
dtEnd = as.character(max(dtEnd, na.rm = T)),
animals = paste0(unique(unlist(str_split(animals, ';'))), collapse = ';'),
localAnimals = paste0(unique(unlist(str_split(localAnimals, ';'))), collapse = ';'),
species = paste0(unique(unlist(str_split(species, ';'))), collapse = ';'),
nAnimals = str_split(animals, ";") %>% unlist %>% length,
nSpecies = str_split(species, ";") %>% unlist %>% length) %>%
filter(!is.na(lat), !is.na(lon))
stations.df %>% write.csv(paste0(dashboard.dir, 'stations.csv'), row.names = F)
# Animals
animals.df <- paste0(dashboard.dir, 'tag-deps.csv') %>% read.csv()
# Prep metadata for dashboard
library(tidyverse)
library(lubridate)
library(fuzzyjoin)
library(geosphere)
dashboard.dir <- "C:/wamp64/www/Motus/Dashboard/data/"
data.dir <- 'E:/Data/'
recvDeps.df <- read.csv(paste0(dashboard.dir, 'recv-deps.csv'))
stations.df <- recvDeps.df %>%
ungroup() %>%
mutate(dtStart = as.Date(dtStart),
dtEnd = if_else(is.na(dtEnd), Sys.Date(), as.Date(dtEnd))) %>%
filter(nchar(name) > 0 & !is.na(dtStart)) %>%
group_by(name) %>%
summarise(nDeps = length(unique(id)),
stationDeps = paste0(id, collapse = ';'),
id = id[1],
name = name[1],
lat = median(lat[1], na.rm = T),
lon = median(lon[1], na.rm = T),
frequency = paste0(unique(frequency), collapse = ';'),
projID = paste0(unique(projID), collapse = ';'),
dtStart = as.character(min(dtStart, na.rm = T)),
dtEnd = as.character(max(dtEnd, na.rm = T)),
animals = paste0(unique(unlist(str_split(animals, ';'))), collapse = ';'),
localAnimals = paste0(unique(unlist(str_split(localAnimals, ';'))), collapse = ';'),
species = paste0(unique(unlist(str_split(species, ';'))), collapse = ';'),
nAnimals = str_split(animals, ";") %>% unlist %>% length,
nSpecies = str_split(species, ";") %>% unlist %>% length,
country = country[1],
continent = continent[1]) %>%
filter(!is.na(lat), !is.na(lon))
# Animals
animals.df <- paste0(dashboard.dir, 'tag-deps.csv') %>% read.csv()
# Species
animals.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv()
# Animals
animals.df <- paste0(dashboard.dir, 'tag-deps.csv') %>% read.csv()
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv()
View(animals.df)
View(stations.df)
stationAnimals.df <- stations.df %>% select(id, animals)
stationAnimals.df <- stations.df %>% select(id, animals) %>%
separate(",")
stationAnimals.df <- stations.df %>% select(id, animals) %>%
separate(animals,";")
View(stationAnimals.df)
?separate
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals)
?pivot_longer
grepl("[0-9]","12")
stationAnimals.df %>% pivot_longer(matches("[0-9]"), names_to = "row_num", values_to = "animal")
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = true) %>%
select(-row_num)
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num)
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(!animal != "NA")
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA")
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';'))
animals.df %>%
left_join(stationAnimals.df, by = c('id' = 'animal'))
typeof(animals.df$id)
typeof(stationAnimals.df$anima)
typeof(stationAnimals.df$animal)
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';')) %>%
mutate(id = as.integer(animal))
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';')) #%>%
stationAnimals.df
stationAnimals.df$animal
as.integer(stationAnimals.df$animal)
as.integer(stationAnimals.df$animal[1:10])
(stationAnimals.df$animal[1:10])
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';')) %>%
mutate(id = as.integer(animal))
animals.df %>%
left_join(stationAnimals.df, by = c('id' = 'animal'))
animals.df %>%
left_join(stationAnimals.df, by = 'id')
stationAnimals.df <- stations.df %>%
select(id, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';')) %>%
mutate(id = as.integer(animal)) %>%
select(-animal)
animals.df %>%
left_join(stationAnimals.df, by = 'id')
stationAnimals.df
animals.df %>%
left_join(stationAnimals.df, by = 'id') %>%
View
stationAnimals.df <- stations.df %>%
select(id, projID, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';')) %>%
mutate(id = as.integer(animal)) %>%
select(-animal)
stationAnimals.df <- stations.df %>%
select(id, projID, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id, projID) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';')) %>%
mutate(id = as.integer(animal)) %>%
select(-animal)
stationAnimals.df <- stations.df %>%
select(id, projID, animals) %>%
mutate(animals = strsplit(animals, ';')) %>%
unnest(animals) %>%
group_by(id, projID) %>%
mutate(row = row_number()) %>%
spread(row, animals) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "animal",
values_drop_na = T) %>%
select(-row_num) %>%
filter(animal != "NA") %>%
group_by(animal) %>%
summarise(stations = paste0(unique(id), collapse = ';'),
projects = paste0(unique(projID), collapse = ';')) %>%
mutate(id = as.integer(animal)) %>%
select(-animal)
animals.df %>%
left_join(stationAnimals.df, by = 'id') %>%
write.csv(paste0(dashboard.dir, 'tag-deps.csv'), row.names = F)
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv()
View(spp.df)
stationSpecies.df <- stations.df %>%
select(id, projID, species) %>%
mutate(species = strsplit(species, ';')) %>%
unnest(species) %>%
group_by(id, projID) %>%
mutate(row = row_number()) %>%
spread(row, species) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "species",
values_drop_na = T) %>%
select(-row_num) %>%
filter(species != "NA") %>%
group_by(species) %>%
summarise(stations = paste0(unique(id), collapse = ';'),
projects = paste0(unique(projID), collapse = ';')) %>%
mutate(id = as.integer(species)) %>%
select(-species)
View(stationSpecies.df)
stationSpecies.df <- stations.df %>%
select(id, projID, species) %>%
mutate(species = strsplit(species, ';')) %>%
unnest(species) %>%
group_by(id, projID) %>%
mutate(row = row_number()) %>%
spread(row, species) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "species",
values_drop_na = T) %>%
select(-row_num) %>%
filter(species != "NA") %>%
group_by(species) %>%
summarise(stations = paste0(unique(id), collapse = ';'),
stationProjects = paste0(unique(projID), collapse = ';')) %>%
mutate(id = as.integer(species)) %>%
select(-species)
spp.df %>%
left_join(stationSpecies.df, by = 'id') %>%
write.csv(paste0(dashboard.dir, 'spp.csv'), row.names = F)
# Animals
animals.df <- paste0(dashboard.dir, 'tag-deps.csv') %>% read.csv()
View(spp.df)
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>%
mutate(projects = str_replace(projects, ",", ";"),
animals = str_replace(animals, ",", ";"))
stationSpecies.df <- stations.df %>%
select(id, projID, species) %>%
mutate(species = strsplit(species, ';')) %>%
unnest(species) %>%
group_by(id, projID) %>%
mutate(row = row_number()) %>%
spread(row, species) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "species",
values_drop_na = T) %>%
select(-row_num) %>%
filter(species != "NA") %>%
group_by(species) %>%
summarise(stations = paste0(unique(id), collapse = ';'),
stationProjects = paste0(unique(projID), collapse = ';')) %>%
mutate(id = as.integer(species)) %>%
select(-species)
spp.df %>%
left_join(stationSpecies.df, by = 'id') %>%
write.csv(paste0(dashboard.dir, 'spp.csv'), row.names = F)
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>%
mutate(projects = str_replace(projects, ",", ";"),
animals = str_replace(animals, ",", ";")) %>%
select(-stations, -stationProjects)
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>%
mutate(projects = str_replace(projects, ",", ";"),
animals = str_replace(animals, ",", ";")) %>%
select(-stations, -stationProjects)
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>%
mutate(projects = str_replace(projects, ",", ";"),
animals = str_replace(animals, ",", ";")) #%>%
View(spp.df)
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>%
mutate(projects = str_replace(projects, ",", ";"),
animals = str_replace(animals, ",", ";")) %>%
select(-contains("station"))
stationSpecies.df <- stations.df %>%
select(id, projID, species) %>%
mutate(species = strsplit(species, ';')) %>%
unnest(species) %>%
group_by(id, projID) %>%
mutate(row = row_number()) %>%
spread(row, species) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "species",
values_drop_na = T) %>%
select(-row_num) %>%
filter(species != "NA") %>%
group_by(species) %>%
summarise(stations = paste0(unique(id), collapse = ';'),
stationProjects = paste0(unique(projID), collapse = ';')) %>%
mutate(id = as.integer(species)) %>%
select(-species)
spp.df %>%
left_join(stationSpecies.df, by = 'id') %>%
write.csv(paste0(dashboard.dir, 'spp.csv'), row.names = F)
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>%
mutate(projects = str_replace(projects, ",", ";"),
animals = str_replace(animals, ",", ";")) %>%
select(-contains("station"))
paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>% View
mutate(projects = gsub(",", ";", projects),
animals = gsub(",", ";", animals)) %>%
select(-contains("station"))
# Species
spp.df <- paste0(dashboard.dir, 'spp.csv') %>% read.csv() %>%
mutate(projects = gsub(",", ";", projects),
animals = gsub(",", ";", animals)) %>%
select(-contains("station"))
stationSpecies.df <- stations.df %>%
select(id, projID, species) %>%
mutate(species = strsplit(species, ';')) %>%
unnest(species) %>%
group_by(id, projID) %>%
mutate(row = row_number()) %>%
spread(row, species) %>%
pivot_longer(matches("[0-9]"),
names_to = "row_num",
values_to = "species",
values_drop_na = T) %>%
select(-row_num) %>%
filter(species != "NA") %>%
group_by(species) %>%
summarise(stations = paste0(unique(id), collapse = ';'),
stationProjects = paste0(unique(projID), collapse = ';')) %>%
mutate(id = as.integer(species)) %>%
select(-species)
spp.df %>%
left_join(stationSpecies.df, by = 'id') %>%
write.csv(paste0(dashboard.dir, 'spp.csv'), row.names = F)
paste0(dashboard.dir, 'spp.csv') %>% read.csv()  %>% view
paste0(dashboard.dir, 'tag-deps.csv') %>% read.csv()  %>% view
